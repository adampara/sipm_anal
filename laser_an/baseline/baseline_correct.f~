
      REAL FUNCTION baseline_correct(tau,nv0)

c     remove effects of the differentiation
 
 
*********************************************************
*                                                       *
* This file was generated by HUWFUN.                    *
*                                                       *
*********************************************************
*
*     Ntuple Id:      30   
*     Ntuple Title:   Waveforms
*     Creation:       14/06/2013 13.41.35
*
*********************************************************
*
      LOGICAL         CHAIN
      CHARACTER*128   CFILE
      INTEGER         IDNEVT,NCHEVT,ICHEVT
      REAL            OBS(13)
*
      COMMON /PAWIDN/ IDNEVT,OBS
      COMMON /PAWCHN/ CHAIN, NCHEVT, ICHEVT
      COMMON /PAWCHC/ CFILE
*
*--   Ntuple Variable Declarations
*
      REAL wf(10000),yorig,yref,yinc,t0,toff
      INTEGER N_wf,is,iwf
*
      COMMON /PAWCR4/ N_wf,wf,yorig,yref,yinc,t0,is,iwf,toff
*
c        ***   wf - original waveform
c        ***   bs - baseline shift
c        ***   v  - corrected waveform

      vector bs
      vector v
      vector wavef
      vector voff

      print *,'   baseline correction'
      att =  exp(-tau)
      print *,'  first point ',wf(1)
      i1=2
      i2=10000

c     ***    loop over the possible offset values

      do j=-nv0,nv0
         v0 = voff(j+1+nv0)
c         print *,' v0 = ',v0
c         v(i1-1) = 0.
         bs(i1-1) = wf(i1-1)-v0 
         wavef(i1-1) = wf(i1-1)
         call hreset(900+j,' ')
c         print *,tau,att
c      ***   correct the waveform using 'v0' as an offset value and store 
c      ***   the 'Hough slope' in histogram 900+j
         do i = i1,i2
*         print *,i
            wavef(i) = wf(i)
            v(i) = (wf(i)-v0 - bs(i-1)*att)
c            v(i) = (wf(i) - bs(i-1)*att) - v0
            bs(i) = bs(i-1)*att -  v(i)*tau
            call hfill(900+j,v(i)/i,0.,1.)
            call hfill(1900+j,float(i),0,v(i))
         enddo

      enddo

      baseline_correct = 1


      END
