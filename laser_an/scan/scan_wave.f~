      REAL FUNCTION pulse_an(thr,chicut)



*********************************************************
*                                                       *
* This file was generated by HUWFUN.                    *
*                                                       *
*********************************************************
*
*     Ntuple Id:      30   
*     Ntuple Title:   Waveforms
*     Creation:       15/07/2013 14.23.15
*
*********************************************************
*
      LOGICAL         CHAIN
      CHARACTER*128   CFILE
      INTEGER         IDNEVT,NCHEVT,ICHEVT
      REAL            OBS(13)
*
      COMMON /PAWIDN/ IDNEVT,OBS
      COMMON /PAWCHN/ CHAIN, NCHEVT, ICHEVT
      COMMON /PAWCHC/ CFILE
*
*--   Ntuple Variable Declarations
*
      REAL wf(10000),yorig,yref,yinc,t0,toff
      INTEGER N_wf,is,iwf
*
      COMMON /PAWCR4/ N_wf,wf,yorig,yref,yinc,t0,is,iwf,toff
*
      common/wave/wave(10000)
      vector coh_noi
      include 'pulses_inc.f'

c     ***   coh_noi is a vector with coherent baseline
c     ***  subtract coherent noise

      do i = 1,10000
        wave(i) = wf(i) - coh_noi(i)
      enddo

      call hist_wave(100)

      call fill_head(N_wf)
      N_puls = 0
      ipulse = 0

      do i = 200,9200
         
         if(wave(i).lt.thr) goto 900
         call match(i,ibest,chibest,xnorm)
         
         if(xnorm.lt.thr .or. chibest.gt.chicut) goto 900

         call hist_templ(200,ibest,xnorm)

         ipulse = ipulse + 1

         call fill_pulse(ipulse,ibest,chibest,xnorm)

c         print *,'pulse ',ipulse,ibest,xnorm
         call  subtract_templ(ibest,xnorm)
         call hist_wave(100+ipulse)
c         print *,ipulse,i,wave(i)

         call hist_templ(200+ipulse,ibest,xnorm)
         call hfill(999,chibest,xnorm,1.)
c         print *,ipulse,ibest,chibest,xnorm
         i = ibest + 1
 900     continue
         
      enddo

c      print *,'pulse_a, write ntuple info'  

         if(N_puls.gt.1) then
            do i=2,N_puls
               t_bef(i) = t(i) - t(i-1)
            enddo
            do i=1,N_puls-1
               t_aft(i)= t(i+1) - t(i)
            enddo
         endif
      write(37,*)'---------------------'
      write(37,*)nwf
      write(37,117)rlgate
      write(37,117)gate
 117  format(10e13.5)
      write(37,117)q
      write(37,117)q_r1
      write(37,117)q_r2
      write(37,117)q_r3
      write(37,117)q_r4
      write(37,*)start
      write(37,*)N_puls
      do i=1,N_puls
         write(37,*)'  peak ',i
         write(37,117)t(i),t_bef(i),t_aft(i)
         write(37,117)chi_peak(i), chi_3tau(i)
         write(37,*)ampl(i)
         write(37,117)wid66(i),wid50(i),wid33(i)
         write(37,*)q_bef(i)
         write(37,117)(pulse(j,i),j=1,100)
      enddo

      END


      subroutine hist_wave(idh)
c     -------------------------
      common/wave/wave(10000)

      do i=1,10000
         call hfill(idh,i-0.5,0.,wave(i))
      enddo

      end

      subroutine hist_templ(idh,ipos,xnorm)
c     -------------------------------------

      vector templ 
c      print *,'fill templete',ipos,idh,xnorm
      do i=1,1000
         call hfill(idh,ipos+i-201.5,0.,xnorm*templ(i))
      enddo

      end

      subroutine subtract_templ(ipos,xnorm)
c     ------------------------------------------

      common/wave/wave(10000)
      vector templ 

      do i=1,1000
         wave(ipos+i-201) = wave(ipos+i-201) -
     +                     xnorm*templ(i)
      enddo

      end
      subroutine match(ithr,ibest,xmin,xnormbest)
c     -------------------------------------------

      xmin = 999

      do j=ithr-3,ithr+5
         a = chi(j,xnorm,12)
c         print *,j,a
         if(a.lt.xmin) then
            xmin = a
            ibest = j
            xnormbest = xnorm

         endif
      enddo

      end

      function chi(ipos,xnorm,len)
c     ----------------------------

      common/wave/wave(10000)
      vector templ

      sum = 0
      sumw = 0
      sumt = 0
      do j = -3,4
         sumw = sumw + wave(ipos+j)
         sumt = sumt + templ(201+j)
      enddo

      xnorm = sumw/sumt

      do j = - 3,  12, 2
         wv = 0.5* (wave(ipos+j) + wave(ipos+j+1))
         tt = 0.5 * xnorm * (templ(201+j) + templ(201+j+1))
         cont = ( (wv - tt)/wv  )**2

c         cont = ((wave(ipos+j) - xnorm * templ(201+j))/
c     +              wave(ipos+j)  )**2

         sum = sum + cont
c       print *,'  chi ',xnorm,j,ipos,ipos+j,
c     +             cont,wave(ipos+j),xnorm*templ(201+j)
      enddo

      chi = sum

      end

      subroutine fill_head(N_wf)
c     -------------------------------

      common/wave/wave(10000)
      include 'pulses_inc.f'
      vector sampl
      integer igate(10)

      data igate / 10, 20, 30, 40, 50, 75,  100,  200, 400, 800/

      Nwf = N_wf

      start = 4995 

      call calc_head(start,q,igate)
      call calc_head(100,q_r1,igate)
      call calc_head(1100,q_r2,igate)
      call calc_head(2100,q_r3,igate)
      call calc_head(3100,q_r4,igate)

      do i = 1,10
         gate(i) = igate(i)*sampl(1)
      enddo

      do i=1,100
        rlgate(i) = wave(i + start - 1)
      enddo

      return
      end

      subroutine calc_head(ist,qq,igate)
c     -------------------------------

      common/wave/wave(10000)
      integer igate(10)
      real qq(10)

c      print *,'calc_head',ist
      do i = 1,10
         qq(i)=0.
         do j=1,igate(i)
            qq(i) = qq(i) + wave(j-1+ist)
         enddo
      enddo

      return
      end


      subroutine fill_pulse(ipulse,ibest,chibest,xnorm)
c     ------------------------------------------------------

      common/wave/wave(10000)
      vector templ
      vector tau
      vector sampl
      include 'pulses_inc.f'
      integer tauint

c      print *,ipulse,ibest
      N_puls = ipulse
      tauint  = nint(3*tau(1)/sampl(1))

      t(ipulse) = ibest*sampl(1)
      t_bef(ipulse) = 0
      t_aft(ipulse) = 0
 
      chi_peak(ipulse) = chi(ibest,xnorm,12)
      chi_3tau(ipulse) = chi(ibest,xnorm,tauint)

      ampl(ipulse) = xnorm

      wid66(ipulse) = width(0.66,ibest)*sampl(1)
      wid50(ipulse) = width(0.50,ibest)*sampl(1)
      wid33(ipulse) = width(0.33,ibest)*sampl(1)

      q_bef(ipulse) = 0.
      do i = ibest- 50, ibest -10
         q_bef(ipulse) = q_bef(ipulse) + wave(i)
      enddo
      
      do i=1,100
        pulse(i,ipulse) = wave(i+ibest-20)
      enddo

      return
      end

      function width(frac,ipeak)
c     -------------------------------

      common/wave/wave(10000)

      thr = wave(ipeak)*frac

      do i=ipeak,ipeak-100,-2
         if(0.5*(wave(i)+wave(i-1)).lt.thr) goto 10
      enddo

 10   ibeg  = i

      do i=ipeak,ipeak+700,2
         if(0.5*(wave(i)+wave(i+1)).lt.thr) goto 20
      enddo

 20   iend = i

      width = iend - ibeg +1

      return
      end
    
      
